<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="title">Sinova</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/home.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" id="navtitle">SINOVA - Página principal</a>
            <button type="button" id="settingsButton" class="btn btn-outline-primary ms-auto" data-bs-toggle="modal" data-bs-target="#ajustesModal">
                <span >Ajustes</span>
            </button>
            <button type="button" id="userProfileButton" class="btn btn-light rounded-circle" data-bs-toggle="modal" data-bs-target="#userProfileModal" title="Perfil del usuario">
                <i class="bi bi-person-circle"></i>
            </button>
        </div> 
    </nav>

    <div class="container-fluid mt-5 d-flex justify-content-center" style="max-width: 1600px;">
        <div class="container" id="filtersPanel" style="width: 30%; max-width: 300px;">
            <h5 class="text-center" id="filtersTitle">Filtros</h5>
            <form id="filterForm" method="GET">
                <div class="mb-3">
                    <label for="filterBy" class="form-label" id="filterByLabel">Filtrar por:</label>
                    <select class="form-select" id="filterBy" name="filterBy">
                        <option value="name" id="nameFilterOption">Nombre</option>
                        <option value="mail" id="mailFilterOption">Correo electrónico</option>
                        <option value="phone" id="phoneFilterOption">Número de teléfono</option>
                    </select>
                    <br>
                    <input type="text" class="form-control" id="filterValue" name="filterValue">
                </div>
                <button type="submit" class="btn btn-primary w-100" id="applyFiltersButton">Aplicar Filtros</button>
            </form>
        </div>
    

        <div class="container" style="width: 90%; max-width: 850px;">
            <h2 id="clientsTitle">Clientes asociados</h2>
            <form id="clientsForm">
                <table class="table table-dark table-striped" id="clientsTable">
                    <thead>
                        <tr>
                            <th id="nameColumn">Nombre</th>
                            <th id="mailColumn">Correo</th>
                            <th id="phoneColumn">Teléfono</th>
                            <th id="completedColumn">Completado</th>
                            <th id="extraInfoColumn">Información extra</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Filas dinámicas cargadas con JavaScript -->
                    </tbody>
                </table>
            </form>
        </div> 

        <!-- Modal con información del usuario -->
        <div class="modal fade" id="userProfileModal" tabindex="-1" aria-labelledby="userProfileModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userProfileModalLabel">Información del usuario</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="user-info-item"><strong>ID:</strong> <span id="userIDPlaceholder"></span></p>
                        <p class="user-info-item"><strong id="userInfoName">Nombre:</strong> <span id="userNamePlaceholder"></span></p>
                        <p class="user-info-item"><strong id="userInfoMail">Correo:</strong> <span id="userEmailPlaceholder"></span></p>
                        <p class="user-info-item"><strong id="userInfoRole">Rol:</strong> <span id="userRolePlaceholder"></span></p>
                    </div>
                    <div class="modal-footer">
                        <!-- Botón de cerrar sesión -->
                        <button type="button" class="btn btn-danger" id="logoutButton">Cerrar sesión</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="userInfoClose">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de ajustes -->
        <div class="modal fade" id="ajustesModal" tabindex="-1" aria-labelledby="ajustesModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="settingsTitle">Ajustes</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <label for="languageSelect" class="form-label" id="selectLanguageLabel">Seleccionar idioma:</label>
                        <select id="languageSelect" class="form-select">
                            <option value="es">Español</option>
                            <option value="en">English</option>
                        </select>
                        <div class="form-group mt-3">
                            <label class="form-label d-block" id="themeLabel">Tema:</label>
                            <div class="d-flex align-items-center">
                                <span class="me-2" id="darkThemeLabel">Oscuro</span>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="darkModeToggle">
                                </div>
                            </div>
                        </div>                    
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeSettingsButton">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Modal para enviar mensaje a soporte técnico -->
        <div class="modal fade" id="supportMessageModal" tabindex="-1" aria-labelledby="supportMessageModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="supportMessageModalLabel">Enviar mensaje a soporte técnico</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <textarea class="form-control" id="supportMessageText" rows="5" placeholder="Escribe tu mensaje aquí..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="sendMessageButton">Enviar</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Modal de confirmación de cierre de sesión -->
        <div class="modal fade" id="confirmLogoutModal" tabindex="-1" aria-labelledby="confirmLogoutModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmLogoutTitle">Confirmar cierre de sesión</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="confirmLogoutLabel">
                        ¿Está seguro de que desea cerrar sesión?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" id="yesLogoutButton">Sí</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="noLogoutButton">No</button>
                    </div>
                </div>
            </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentLanguage = localStorage.getItem('language') || 'es'; // 'es' por defecto

        document.addEventListener("DOMContentLoaded", function () {
            let currentLanguage = localStorage.getItem("language") || "es";
            const darkModeToggle = document.getElementById("darkModeToggle");
            const table = document.getElementById("clientsTable");
            const tableBody = document.querySelector("#clientsTable tbody");
            const filterForm = document.getElementById("filterForm");
            const filterBySelect = document.getElementById("filterBy");
            const filterInput = document.getElementById("filterValue");

            function loadLanguage(lang) {
                const timestamp = new Date().getTime();
                fetch(`idiomas/home/${lang}.txt?t=${timestamp}`)
                    .then(response => {
                        if (!response.ok) throw new Error("Error en la carga del archivo de idioma: " + response.status);
                        return response.text();
                    })
                    .then(data => {
                        const lines = data.split("\n");
                        const ids = [
                            "navtitle", "settingsButton", "settingsTitle", "selectLanguageLabel",
                            "closeSettingsButton", "logoutButton", "confirmLogoutLabel",
                            "confirmLogoutTitle", "yesLogoutButton", "noLogoutButton",
                            "clientsTitle", "nameColumn", "mailColumn", "phoneColumn",
                            "completedColumn", "extraInfoColumn", "userProfileModalLabel",
                            "userInfoName", "userInfoMail", "userInfoRole", "userInfoClose",
                            "themeLabel", "darkThemeLabel", "filterTitle", "filterByLabel",
                            "nameFilterOption", "mailFilterOption", "phoneFilterOption",
                            "applyFiltersButton"
                        ];

                        ids.forEach((id, index) => {
                            const element = document.getElementById(id);
                            if (element) element.innerText = lines[index] || "";
                        });

                        const languageSelect = document.getElementById("languageSelect");
                        languageSelect.innerHTML = lang === "es" ?
                            '<option value="es" selected>Español</option><option value="en">English</option>' :
                            '<option value="es">Spanish</option><option value="en" selected>English</option>';
                    })
                    .catch(error => console.error("Error al cargar el idioma:", error));
            }

            if (document.documentElement.lang !== currentLanguage) {
                document.documentElement.lang = currentLanguage;
                loadLanguage(currentLanguage);
            }
            loadLanguage(currentLanguage);

            if (!darkModeToggle) {
                console.error("No se encontró el switch de modo oscuro en el DOM.");
                return;
            }

            const isDarkMode = localStorage.getItem("darkMode") === "enabled";
            document.body.classList.toggle("light-mode", !isDarkMode);
            table.classList.toggle("table-dark", isDarkMode);
            darkModeToggle.checked = isDarkMode;

            darkModeToggle.addEventListener("change", function () {
                const enableDarkMode = this.checked;
                document.body.classList.toggle("light-mode", !enableDarkMode);
                table.classList.toggle("table-dark", enableDarkMode);
                localStorage.setItem("darkMode", enableDarkMode ? "enabled" : "disabled");
            });

            document.getElementById("languageSelect").addEventListener("change", function () {
                const selectedLanguage = this.value;
                localStorage.setItem("language", selectedLanguage);
                if (selectedLanguage !== currentLanguage) location.reload();
            });

            function getQueryParam(param) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(param) || "";
            }

            if (!tableBody || !filterBySelect || !filterInput || !applyFiltersButton) {
                console.error("No se encontró uno de los elementos necesarios en el DOM.");
                return;
            }

            function fetchClients(filterBy = "", filterValue = "") {
                let formData = new URLSearchParams();
                formData.append("fetchClients", "true");

                if (filterBy && filterValue) {
                    formData.append("filterBy", filterBy);
                    formData.append("filterValue", filterValue);
                }

                fetch("../src/home.php", {
                    method: "POST",
                    body: formData,
                    headers: { "Content-Type": "application/x-www-form-urlencoded" }
                })
                .then(response => response.json())
                .then(data => {
                    tableBody.innerHTML = "";
                    if (data.length > 0) {
                        data.forEach(client => {
                            tableBody.innerHTML += `
                                <tr>
                                    <td>${client.nombre}</td>
                                    <td>${client.email}</td> 
                                    <td>${client.telefono}</td>
                                    <td><input type="checkbox" class="client-completed" name="completado[]" value="${client.id}" data-id="${client.id}"${client.completado ? "checked" : ""}></td>
                                    <td><textarea class="client-extrainfo" name="extrainfo[${client.id}]" data-id="${client.id}" rows="2" cols="50">${client.extrainfo}</textarea></td>
                                </tr>`;
                        });
                    } else {
                        tableBody.innerHTML = "<tr><td colspan='5'>No se encontraron clientes asociados.</td></tr>";
                    }
                })
                .catch(error => console.error("Error al cargar los clientes:", error));
            }


            // Leer parámetros de la URL y establecer en los campos de filtro
            const urlParams = new URLSearchParams(window.location.search);
            const filterBy = urlParams.get("filterBy") || "";
            const filterValue = urlParams.get("filterValue") || "";

            if (filterBy && filterBySelect) {
                filterBySelect.value = filterBy;
            }

            if (filterValue && filterInput) {
                filterInput.value = filterValue;
            }

            // Cargar clientes con filtros si están en la URL
            fetchClients(filterBy, filterValue);

            // Función para actualizar la base de datos con los campos completado y extrainfo
            function updateClientData(callback) {
                const clientData = [];

                document.querySelectorAll(".client-completed").forEach(checkbox => {
                    const id = checkbox.dataset.id;
                    const extrainfo = document.querySelector(`.client-extrainfo[data-id="${id}"]`).value.trim();
                    clientData.push({
                        id,
                        completado: checkbox.checked ? 1 : 0,
                        extrainfo: extrainfo
                    });
                });

                fetch("../src/update_clients.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ clients: clientData })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log("Clientes actualizados correctamente");
                        if (callback) callback();
                    } else {
                        console.error("Error al actualizar clientes:", data.error);
                    }
                })
                .catch(error => console.error("Error al actualizar los clientes:", error));
            }

            // Aplicar filtros y actualizar clientes antes de recargar
            if (filterForm) {
                filterForm.addEventListener("submit", function (event) {
                    event.preventDefault();

                    const filterBy = filterBySelect.value;
                    const filterValue = filterInput.value.trim();

                    updateClientData(() => {
                        window.location.href = `?filterBy=${encodeURIComponent(filterBy)}&filterValue=${encodeURIComponent(filterValue)}`;
                    });
                });
            } else {
                console.error("No se encontró el formulario de filtros en el DOM.");
            }

            fetch("../src/home.php", { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: "fetchUserInfo=true" })
                .then(response => response.json())
                .then(data => {
                    document.getElementById("userIDPlaceholder").innerText = data.id;
                    document.getElementById("userNamePlaceholder").innerText = data.nombre_usuario;
                    document.getElementById("userEmailPlaceholder").innerText = data.email;
                    let roleText = currentLanguage === "es" ? ["Administrador", "Usuario", "Supervisor"][data.rol] || "Desconocido" :
                        ["Admin", "User", "Supervisor"][data.rol] || "Unknown";
                    document.getElementById("userRolePlaceholder").innerText = roleText;
                })
                .catch(error => console.error("Error al obtener la información del usuario:", error));

            document.getElementById("logoutButton").addEventListener("click", function () {
                const modal = new bootstrap.Modal(document.getElementById("confirmLogoutModal"));
                modal.show();
            });

            document.getElementById("yesLogoutButton").addEventListener("click", function () {
                const form = document.getElementById("clientsForm");
                const formData = new FormData(form);

                fetch("../src/update_clients.php", { method: "POST", body: formData })
                    .then(response => {
                        if (response.ok) return fetch("../src/logout.php", { method: "POST" });
                        throw new Error("Error al actualizar los clientes.");
                    })
                    .then(response => {
                        if (response.ok) window.location.href = "index.html";
                        else throw new Error("Error al cerrar sesión.");
                    })
                    .catch(error => console.error("Error:", error));
            });


            document.getElementById("applyFiltersButton").addEventListener("click", function (event) {
                event.preventDefault(); // Evita que el formulario se envíe directamente

                const form = document.getElementById("clientsForm");
                
                const formData = new FormData(form);



                fetch("../src/update_clients.php", { method: "POST", body: formData })
                    .then(response => {
                        if (response.ok) {
                            // Obtener los valores del filtro para mantenerlos en la URL
                            const filterBy = document.getElementById("filterBy").value;
                            const filterValue = document.getElementById("filterValue").value.trim();
                            window.location.href = `?filterBy=${encodeURIComponent(filterBy)}&filterValue=${encodeURIComponent(filterValue)}`;
                        } else {
                            throw new Error("Error al actualizar los clientes.");
                        }
                    })
                    .catch(error => console.error("Error al actualizar los clientes:", error));
            });


        });




    </script>
</body>
</html>
